name: Despliegue a produccion

on:
  push:
    branches: [main]

jobs:
  tests: # Job para ejecutar pruebas
    runs-on: ubuntu-latest # Crea un entorno virtual en Ubuntu
    steps:
      - name: Checkout código # Clona el repositorio en el entorno virtual
        uses: actions/checkout@v4 # Usa una acción de GitHub

      - name: Instalar Node.js # Instala Node.js en el entorno virtual
        uses: actions/setup-node@v4
        with:
          node-version: "22.0"

      - name: Iniciar MongoDB
        uses: supercharge/mongodb-github-action@1.11.0
        with:
          mongodb-version: '6.0'

      - name: Instalar dependencias de producción del backend
        run: |
          cd backend || { echo "No se pudo acceder al directorio del backend"; exit 1; }
          npm install

      - name: Ejecutar pruebas # Ejecuta las pruebas del proyecto
        run: |
          cd backend || { echo "No se pudo acceder al directorio del backend"; exit 1; }
          npm test
        env:
          MONGO_URI_TEST: mongodb://localhost:27017/test

  # CUIDADO: Las conexiones SSH y OpenVPN pueden ser peligrosas si no se protegen correctamente.
  # Asegúrate de que todas las credenciales estén protegidas usando los secretos del repositorio.
  # EN NINGÚN CASO SE DEBEN DEJAR CREDENCIALES EXPUESTAS EN ESTE ARCHIVO NI EN NINGÚN OTRO.
  # Si no sabes cómo proteger tus credenciales, consulta la documentación de GitHub o pregunta a un profesor.
  # https://docs.github.com/es/actions/security-guides/encrypted-secrets

  deploy: # Job para desplegar el proyecto
    needs: tests
    runs-on: ubuntu-latest
    steps:
      - name: Instalar dependencias (OpenVPN, SSH y sshpass)
        run: |
          sudo apt update -qq > /dev/null 2>&1
          sudo apt install -y -qq openvpn openvpn-systemd-resolved openssh-client sshpass

      - name: Crear archivo de configuración OpenVPN # Crea el archivo de configuración de OpenVPN en memoria
        run: |
          echo "${{ secrets.OPENVPN_CONFIG }}" | base64 -d > /dev/shm/face-ubb.ovpn

        # Conecta a la VPN de la UBB usando un action de GitHub del usuario kota65535.
        # Tambien se podría usar el cliente de OpenVPN directamente.
        # La ventaja de usar el action es que se encarga de crear el cliente y manejar la conexión por nosotros.
        # Más información en https://github.com/kota65535/github-openvpn-connect-action/tree/v3.1.0/
      - name: Conexion a la VPN de la UBB
        uses: kota65535/github-openvpn-connect-action@v3.1.0
        timeout-minutes: 2
        continue-on-error: false
        with:
          config_file: /dev/shm/face-ubb.ovpn
          username: ${{ secrets.OPENVPN_USERNAME }}
          password: ${{ secrets.OPENVPN_PASSWORD }}

      - name: Eliminar archivo de configuración OpenVPN
        if: always()
        run: rm -f /dev/shm/face-ubb.ovpn

      # La siguiente sección es para conectarse al servidor y desplegar el código
      # Este ejemplo usa sshpass para conectarse al servidor usando SSH.
      # Es recomendable usar claves SSH en lugar de contraseñas para mayor seguridad, evitando el uso de contraseñas.
      # Hay muchas formas de hacer esto, este es solo un ejemplo sencillo con Node. Debe ser adaptado a tu proyecto.

      - name: Conexión SSH y Despliegue
        timeout-minutes: 3
        #1. Conectarse al servidor via SSH
        #2. Acceder al directorio del proyecto
        #3. Actualizar el código fuente desde el repositorio
        #4. Instalar dependencias necesarias
        run: |
          sshpass -p "${{ secrets.PROD_PASSWORD }}" ssh \
            -q \
            -o StrictHostKeyChecking=no \
            -p ${{ secrets.PROD_PORT }} \
            ${{ secrets.PROD_USER }}@${{ secrets.PROD_HOST }} << 'EOF'
              # comando para detener el script si hay un error, si se usa una variable no definida o si un comando falla
              set -euo pipefail

              # acceder al directorio del proyecto
              echo "Conectando al servidor..."
              echo "Accediendo al directorio del proyecto..."
              cd "${{ secrets.PROD_ROUTE }}/" || { echo "No se pudo acceder al directorio del proyecto"; exit 1; }

              # actualizar el código fuente, instalar dependencias y reiniciar servicios
              echo "Actualizando el código fuente..."
              git fetch origin main || { echo "Error al obtener cambios del repositorio"; exit 1; }
              git checkout main || { echo "Error al cambiar a la rama main"; exit 1; }
              git reset --hard origin/main || { echo "Error al actualizar el código"; exit 1; }
              echo "Rama actual: $(git branch --show-current)"
              echo "Último commit: $(git log -1 --oneline)"

              # instalar dependencias del BACKEND
              echo "Instalando dependencias del backend..."
              cd backend || { echo "No se pudo acceder al directorio del backend"; exit 1; }
              npm ci
              cd ..

              # instalar dependencias del FRONTEND
              echo "=== Instalando y construyendo el frontend... ==="
              cd frontend || { echo "No se pudo acceder al directorio del frontend"; exit 1; }
              npm ci
              echo "=== Construyendo el frontend... ==="
              npm run build
              cd ..

              # Desplegar archivos del frontend al servidor web
              echo "=== Removiendo datos anteriores de build... ==="
              sudo rm -rf /var/www/html/miespacioubb/*
              echo "=== Copiando nuevos archivos al servidor web... ==="
              sudo cp -r frontend/dist/* /var/www/html/miespacioubb/
              # Cambiar propietario
              echo "=== Cambiando permisos de los archivos... ==="
              sudo chown -R www-data:www-data /var/www/html/miespacioubb
              sudo chmod -R 755 /var/www/html/miespacioubb
              echo "=== Reiniciando Apache... ==="
              sudo apachectl -k graceful

              # Gestión de procesos con PM2
              echo "=== Gestionando procesos con PM2... ==="
              
              # Verificar si PM2 está instalado
              if ! command -v pm2 &> /dev/null; then
                echo "PM2 no encontrado. Instalando PM2 globalmente..."
                npm install -g pm2
              else
                echo "PM2 ya está instalado: $(pm2 --version)"
              fi
              
              # Verificar si PM2 ya tiene procesos configurados
              if pm2 list | grep -q "online\|stopped\|errored"; then
                echo "Procesos PM2 encontrados. Reiniciando..."
                pm2 restart all
                pm2 save
              else
                echo "No se encontraron procesos PM2. Configurando desde cero..."
                
                # Ir al directorio del backend
                cd backend
                
                # Iniciar el backend con PM2
                pm2 start src/index.js --name "miespacioubb-backend" --watch --ignore-watch="node_modules"
                
                # Guardar la configuración de PM2
                pm2 save
                
                # Configurar PM2 para que inicie al reiniciar el servidor (puede requerir sudo)
                pm2 startup || echo "Nota: pm2 startup requiere configuración manual con sudo"
              fi
              
              echo "=== Estado de PM2 ==="
              pm2 list
          EOF
