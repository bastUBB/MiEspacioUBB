name: Despliegue a produccion

on:
  push:
    branches: [main]

jobs:
  tests: # Job para ejecutar pruebas
    runs-on: ubuntu-latest # Crea un entorno virtual en Ubuntu
    steps:
      - name: Checkout código # Clona el repositorio en el entorno virtual
        uses: actions/checkout@v4 # Usa una acción de GitHub

      - name: Instalar Node.js # Instala Node.js en el entorno virtual
        uses: actions/setup-node@v4
        with:
          node-version: "22.0"

      - name: Iniciar MongoDB
        uses: supercharge/mongodb-github-action@1.11.0
        with:
          mongodb-version: "6.0"

      - name: Instalar dependencias de producción del backend
        run: |
          cd backend || { echo "No se pudo acceder al directorio del backend"; exit 1; }
          npm cache clean --force
          npm ci
          # Workaround para bug de npm con dependencias opcionales de Rollup
          npm install --no-save @rollup/rollup-linux-x64-gnu
        env:
          npm_config_optional: true

      - name: Ejecutar pruebas # Ejecuta las pruebas del proyecto
        run: |
          cd backend || { echo "No se pudo acceder al directorio del backend"; exit 1; }
          npm test
        env:
          MONGO_URI_TEST: mongodb://localhost:27017/test

  deploy: # Job para desplegar el proyecto
    needs: tests
    runs-on: ubuntu-latest
    steps:
      - name: Instalar dependencias (OpenVPN, SSH y sshpass)
        run: |
          sudo apt update -qq > /dev/null 2>&1
          sudo apt install -y -qq openvpn openvpn-systemd-resolved openssh-client sshpass

      - name: Crear archivo de configuración OpenVPN
        run: |
          echo "${{ secrets.OPENVPN_CONFIG }}" | base64 -d > /dev/shm/face-ubb.ovpn

      - name: Conexion a la VPN de la UBB
        uses: kota65535/github-openvpn-connect-action@v3.1.0
        timeout-minutes: 2
        continue-on-error: false
        with:
          config_file: /dev/shm/face-ubb.ovpn
          username: ${{ secrets.OPENVPN_USERNAME }}
          password: ${{ secrets.OPENVPN_PASSWORD }}

      - name: Eliminar archivo de configuración OpenVPN
        if: always()
        run: rm -f /dev/shm/face-ubb.ovpn

      - name: Conexión SSH y Despliegue
        timeout-minutes: 3
        run: |
          sshpass -p "${{ secrets.PROD_PASSWORD }}" ssh \
            -q \
            -o StrictHostKeyChecking=no \
            -p ${{ secrets.PROD_PORT }} \
            ${{ secrets.PROD_USER }}@${{ secrets.PROD_HOST }} << 'EOF'
              set -euo pipefail

              echo "Conectando al servidor..."
              echo "Accediendo al directorio del proyecto..."
              cd "${{ secrets.PROD_ROUTE }}/" || { echo "No se pudo acceder al directorio del proyecto"; exit 1; }

              # Actualizar código fuente con limpieza robusta
              echo "Actualizando el código fuente..."
              echo "Limpiando cambios locales..."
              git clean -fd || { echo "Error al limpiar archivos"; exit 1; }
              git checkout -- . || { echo "Error al descartar cambios"; exit 1; }
              git fetch origin main || { echo "Error al obtener cambios del repositorio"; exit 1; }
              git checkout main || { echo "Error al cambiar a la rama main"; exit 1; }
              git reset --hard origin/main || { echo "Error al actualizar el código"; exit 1; }
              echo "Rama actual: $(git branch --show-current)"
              echo "Último commit: $(git log -1 --oneline)"

              # Instalar dependencias del BACKEND
              echo "Instalando dependencias del backend..."
              cd backend || { echo "No se pudo acceder al directorio del backend"; exit 1; }
              npm install
              cd ..

              # Instalar dependencias del FRONTEND
              echo "=== Instalando y construyendo el frontend... ==="
              cd frontend || { echo "No se pudo acceder al directorio del frontend"; exit 1; }
              npm install
              echo "=== Construyendo el frontend... ==="
              npm run build
              cd ..

              # Desplegar archivos del frontend al servidor web
              echo "=== Removiendo datos anteriores de build... ==="
              sudo rm -rf /var/www/html/*
              echo "=== Copiando nuevos archivos al servidor web... ==="
              sudo cp -r frontend/dist/* /var/www/html/
              echo "=== Cambiando permisos de los archivos... ==="
              sudo chown -R www-data:www-data /var/www/html
              sudo chmod -R 755 /var/www/html
              
              # Configurar Apache con Socket.IO y SPA routing
              echo "=== Configurando proxy reverso de Apache... ===" 
              sudo a2enmod proxy proxy_http proxy_wstunnel rewrite 2>/dev/null || true
              
              # Extraer host:port de la URL del backend para Socket.IO
              BACKEND_URL_VAL="${{ secrets.BACKEND_URL }}"
              BACKEND_AUTHORITY=$(echo "$BACKEND_URL_VAL" | sed -E 's/^\w+:\/\///')
              BACKEND_AUTHORITY=$(echo "$BACKEND_AUTHORITY" | sed -E 's/\/api\/?$//')
              
              # Crear configuración del VirtualHost
              echo '<VirtualHost *:80>' | sudo tee /etc/apache2/sites-available/000-default.conf > /dev/null
              echo '    ServerAdmin webmaster@localhost' | sudo tee -a /etc/apache2/sites-available/000-default.conf > /dev/null
              echo '    DocumentRoot /var/www/html' | sudo tee -a /etc/apache2/sites-available/000-default.conf > /dev/null
              echo '' | sudo tee -a /etc/apache2/sites-available/000-default.conf > /dev/null
              
              # Proxy para el backend API
              echo '    # Proxy para el backend API' | sudo tee -a /etc/apache2/sites-available/000-default.conf > /dev/null
              echo '    ProxyPreserveHost On' | sudo tee -a /etc/apache2/sites-available/000-default.conf > /dev/null
              echo '    ProxyPass /api/ ${{ secrets.BACKEND_URL }}/' | sudo tee -a /etc/apache2/sites-available/000-default.conf > /dev/null
              echo '    ProxyPassReverse /api/ ${{ secrets.BACKEND_URL }}/' | sudo tee -a /etc/apache2/sites-available/000-default.conf > /dev/null
              echo '' | sudo tee -a /etc/apache2/sites-available/000-default.conf > /dev/null
              
              # Configuración para Socket.IO
              echo '    # Configuración para Socket.IO' | sudo tee -a /etc/apache2/sites-available/000-default.conf > /dev/null
              echo '    RewriteEngine On' | sudo tee -a /etc/apache2/sites-available/000-default.conf > /dev/null
              echo '    RewriteCond %{REQUEST_URI}  ^/socket.io            [NC]' | sudo tee -a /etc/apache2/sites-available/000-default.conf > /dev/null
              echo '    RewriteCond %{HTTP:Upgrade} =websocket             [NC]' | sudo tee -a /etc/apache2/sites-available/000-default.conf > /dev/null
              echo "    RewriteRule /(.*)           ws://$BACKEND_AUTHORITY/\$1 [P,L]" | sudo tee -a /etc/apache2/sites-available/000-default.conf > /dev/null
              echo '' | sudo tee -a /etc/apache2/sites-available/000-default.conf > /dev/null
              echo '    RewriteCond %{REQUEST_URI}  ^/socket.io            [NC]' | sudo tee -a /etc/apache2/sites-available/000-default.conf > /dev/null
              echo "    RewriteRule /(.*)           http://$BACKEND_AUTHORITY/\$1 [P,L]" | sudo tee -a /etc/apache2/sites-available/000-default.conf > /dev/null
              echo '' | sudo tee -a /etc/apache2/sites-available/000-default.conf > /dev/null
              
              # Directory con fallback para SPA
              echo '    <Directory /var/www/html>' | sudo tee -a /etc/apache2/sites-available/000-default.conf > /dev/null
              echo '        Options Indexes FollowSymLinks' | sudo tee -a /etc/apache2/sites-available/000-default.conf > /dev/null
              echo '        AllowOverride All' | sudo tee -a /etc/apache2/sites-available/000-default.conf > /dev/null
              echo '        Require all granted' | sudo tee -a /etc/apache2/sites-available/000-default.conf > /dev/null
              echo '' | sudo tee -a /etc/apache2/sites-available/000-default.conf > /dev/null
              echo '        # Fallback para React Router - NO aplicar a /api/* ni /socket.io/*' | sudo tee -a /etc/apache2/sites-available/000-default.conf > /dev/null
              echo '        RewriteEngine On' | sudo tee -a /etc/apache2/sites-available/000-default.conf > /dev/null
              echo '        RewriteBase /' | sudo tee -a /etc/apache2/sites-available/000-default.conf > /dev/null
              echo '        RewriteCond %{REQUEST_URI} !^/api' | sudo tee -a /etc/apache2/sites-available/000-default.conf > /dev/null
              echo '        RewriteCond %{REQUEST_URI} !^/socket.io' | sudo tee -a /etc/apache2/sites-available/000-default.conf > /dev/null
              echo '        RewriteRule ^index\.html$ - [L]' | sudo tee -a /etc/apache2/sites-available/000-default.conf > /dev/null
              echo '        RewriteCond %{REQUEST_URI} !^/api' | sudo tee -a /etc/apache2/sites-available/000-default.conf > /dev/null
              echo '        RewriteCond %{REQUEST_URI} !^/socket.io' | sudo tee -a /etc/apache2/sites-available/000-default.conf > /dev/null
              echo '        RewriteCond %{REQUEST_FILENAME} !-f' | sudo tee -a /etc/apache2/sites-available/000-default.conf > /dev/null
              echo '        RewriteCond %{REQUEST_FILENAME} !-d' | sudo tee -a /etc/apache2/sites-available/000-default.conf > /dev/null
              echo '        RewriteRule . /index.html [L]' | sudo tee -a /etc/apache2/sites-available/000-default.conf > /dev/null
              echo '    </Directory>' | sudo tee -a /etc/apache2/sites-available/000-default.conf > /dev/null
              echo '' | sudo tee -a /etc/apache2/sites-available/000-default.conf > /dev/null
              echo '    ErrorLog ${APACHE_LOG_DIR}/error.log' | sudo tee -a /etc/apache2/sites-available/000-default.conf > /dev/null
              echo '    CustomLog ${APACHE_LOG_DIR}/access.log combined' | sudo tee -a /etc/apache2/sites-available/000-default.conf > /dev/null
              echo '</VirtualHost>' | sudo tee -a /etc/apache2/sites-available/000-default.conf > /dev/null

              # Reiniciar Apache
              echo "=== Reiniciando Apache... ==="
              sudo service apache2 restart

              # Gestión de procesos con PM2
              echo "=== Gestionando procesos con PM2... ==="
              if ! command -v pm2 &> /dev/null; then
                echo "PM2 no encontrado. Instalando PM2 globalmente..."
                npm install -g pm2
              else
                echo "PM2 ya está instalado: $(pm2 --version)"
              fi
              
              if pm2 list | grep -q "online\|stopped\|errored"; then
                echo "Procesos PM2 encontrados. Reiniciando..."
                pm2 restart all
                pm2 save
              else
                echo "No se encontraron procesos PM2. Configurando desde cero..."
                cd backend
                pm2 start src/index.js --name "miespacioubb-backend" --watch --ignore-watch="node_modules"
                pm2 save
                pm2 startup || echo "Nota: pm2 startup requiere configuración manual con sudo"
              fi
              
              echo "=== Estado de PM2 ==="
              pm2 list
          EOF
